---
title: "Analysis"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
      number_sections: yes
    code_folding: hide
    number_sections: yes
editor_options:
  chunk_output_type: console
---
# Setup

```{r setup}
knitr::opts_chunk$set(
	echo = FALSE,
	results = "asis",
	message = FALSE,
	warning = FALSE, 
	fig.height = 18, 
	fig.width = 11, 
	cache = TRUE
)
options(scipen=9999) # desactivar notacion cientifica
remove(list = ls()) #limpieza del entorno de trabajo
```

```{css, echo=FALSE}
# /* expandir el espacio del documento*/
body .main-container {
      max-width: 2000px !important;
      width: 2000px !important;
    }
#/* expandir width de la TOC*/
div.tocify {
    width: 22% !important;
    max-width: 331px !important;
    max-height: 102% !important;
}
```

# Descriptive analysis

## Univariate

```{r tab-desc, results="asis", warning=FALSE}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               summarytools,
               sjlabelled
               )
load(file = here::here("input/data-proc/df_study_t5_ind_comunas.RData"))
# Css
st_css()
st_options(lang = "en",
           footnote = NA,
           bootstrap.css = F,
           custom.css = here::here("input/css/dfsummary.css"),
           dfSummary.custom.1 = NA
           )  

# Descriptive table __________________________________________________________
df_study1 <- 
  df_study_long_t5_comunas %>% 
  select(in_ansied,in_simpat,in_valfam,in_valami,in_amigcl,
         in_simili,in_amsimb,in_acpier,in_acadop,
         conviviality, identity,
         in_amreal,
         educ,quintil1:edad,
         inm_prop_cas17_w,inm_prop_cas20_w,dif_inm) 
# extract variable labels
lab_study1 <- sjlabelled::get_label(df_study1) 
# convert items to factor
for (i in names(select(df_study1,starts_with("in_")))) {
  df_study1[[i]] <- factor(df_study1[[i]],1:5,get_labels(df_study1[[i]]))
}
# set variable labels
df_study1 <- df_study1 %>% na.omit() %>% sjlabelled::set_label(lab_study1)

df<- dfSummary(x = df_study1,
               plain.ascii = FALSE,
               style = "grid",
               tmp.img.dir = "/tmp",
               graph.magnif = TRUE,
               headings = F,  # encabezado
               varnumbers = F, # num variable
               labels.col = T, # etiquetas
               na.col = F,    # missing
               graph.col = T, # plot
               valid.col = T, # n valido
               col.widths = c(700,10,10,10,10,10)
               )
# df$Variable <- NULL # delete variable column
view(df,
     file = here::here("output/tables/desc01.html")
     ) # Ver tabla en un archivo HTML
webshot::webshot(url =here::here("output/tables/desc01.html"),
        file =here::here("output/tables/desc01.png")) # Remover archivo HTML
# print(df, method = "render")
```

## Correlation

```{r cor-plot, fig.dim=c(10,6)}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               sjPlot,
               sjmisc,
               summarytools,
               lavaan
               )
load(file = here::here("input/data-proc/df_study_t5_ind_comunas.RData"))

# Full sample_______________________________________________________________________
mat_full<- 
df_study_long_t5_comunas %>%
  # filter(ola==1) %>%
  select(in_ansied,in_simpat,in_valfam, in_valami,in_amigcl, # conviviality
         in_simili,in_amsimb,in_acpier, in_acadop, # identity
         in_amreal # threat
         ) %>% 
  psych::mixedCor() 

cor_full <- as.matrix(mat_full$rho)
diag(cor_full) = NA #set diagonal values to NA
# Set Row names of the matrix
rownames(cor_full) <- c("A. Interaction anxiety with [PER/HAI/VEN]",
                     "B. Sympathy for [PER/HAI/VEN] living in Chile",
                     "C. Family value of immigrant friends [PER/HAI/VEN]",
                     "D. Friends value of immigrant friends [PER/HAI/VEN]",
                     "E. Immigrants [PER/HAI/VEN] have Chilean friends",
                     "F. Similarity between Chileans and [PER/HAI/VEN]",
                     "G. Loose of identity because of immigrants ",
                     "H. Immigrant keeping their customs",
                     "I. Adoption of Chilean customs",
                     "J. Unemployment increases")
#set Column names of the matrix
colnames(cor_full) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)","(H)","(I)","(J)")
#Plot the matrix using corrplot
corrplot::corrplot(cor_full,
  method = "color",
  addCoef.col = "#000390",
  type = "upper",
  tl.col = "black",
  col=colorRampPalette(c("white","#0068DC"))(12),
  bg = "white",
  na.label = "-",
  title = "\n Full sample")

# Wave 1_______________________________________________________________________
mat_1<- 
df_study_long_t5_comunas %>%
  filter(ola==1) %>%
  select(in_ansied,in_simpat,in_valfam, in_valami,in_amigcl, # conviviality
         in_simili,in_amsimb,in_acpier, in_acadop, # identity
         in_amreal # threat
         ) %>% 
  psych::mixedCor() 

cor_1 <- as.matrix(mat_1$rho)
diag(cor_1) = NA #set diagonal values to NA
# Set Row names of the matrix
rownames(cor_1) <- c("A. Interaction anxiety with [PER/HAI/VEN]",
                     "B. Sympathy for [PER/HAI/VEN] living in Chile",
                     "C. Family value of immigrant friends [PER/HAI/VEN]",
                     "D. Friends value of immigrant friends [PER/HAI/VEN]",
                     "E. Immigrants [PER/HAI/VEN] have Chilean friends",
                     "F. Similarity between Chileans and [PER/HAI/VEN]",
                     "G. Loose of identity because of immigrants ",
                     "H. Immigrant keeping their customs",
                     "I. Adoption of Chilean customs",
                     "J. Unemployment increases")
#set Column names of the matrix
colnames(cor_1) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)","(H)","(I)","(J)")
#Plot the matrix using corrplot
corrplot::corrplot(cor_1,
  method = "color",
  addCoef.col = "#000390",
  type = "upper",
  tl.col = "black",
  col=colorRampPalette(c("white","#0068DC"))(12),
  bg = "white",
  na.label = "-",
  title = "\n Wave 1")

# Wave 2_______________________________________________________________________
mat_2<-   
df_study_long_t5_comunas %>%
  filter(ola==2) %>% 
  select(in_ansied,in_simpat,in_valfam, in_valami,in_amigcl, # conviviality
         in_simili,in_amsimb,in_acpier, in_acadop, # identity
         in_amreal # threat
         ) %>% 
  psych::mixedCor() 

cor_2 <- as.matrix(mat_2$rho)
diag(cor_2) = NA #set diagonal values to NA
# Set Row names of the matrix
rownames(cor_2) <- c("A. Interaction anxiety with [PER/HAI/VEN]",
                     "B. Sympathy for [PER/HAI/VEN] living in Chile",
                     "C. Family value of immigrant friends [PER/HAI/VEN]",
                     "D. Friends value of immigrant friends [PER/HAI/VEN]",
                     "E. Immigrants [PER/HAI/VEN] have Chilean friends",
                     "F. Similarity between Chileans and [PER/HAI/VEN]",
                     "G. Loose of identity because of immigrants ",
                     "H. Immigrant keeping their customs",
                     "I. Adoption of Chilean customs",
                     "J. Unemployment increases")
#set Column names of the matrix
colnames(cor_2) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)","(H)","(I)","(J)")
#Plot the matrix using corrplot
corrplot::corrplot(cor_2,
  method = "color",
  addCoef.col = "#000390",
  type = "upper",
  tl.col = "black",
  col=colorRampPalette(c("white","#0068DC"))(12),
  bg = "white",
  na.label = "-",
  title = "\n Wave 2")


# Wave 3_______________________________________________________________________
mat_3 <- 
df_study_long_t5_comunas %>%
  filter(ola==3) %>% 
  select(in_ansied,in_simpat,in_valfam, in_valami,in_amigcl, # conviviality
         in_simili,in_amsimb,in_acpier, in_acadop, # identity
         in_amreal # threat
         ) %>% 
  psych::mixedCor()  

cor_3 <- as.matrix(mat_3$rho)
diag(cor_3) = NA #set diagonal values to NA
# Set Row names of the matrix
rownames(cor_3) <- c("A. Interaction anxiety with [PER/HAI/VEN]",
                     "B. Sympathy for [PER/HAI/VEN] living in Chile",
                     "C. Family value of immigrant friends [PER/HAI/VEN]",
                     "D. Friends value of immigrant friends [PER/HAI/VEN]",
                     "E. Immigrants [PER/HAI/VEN] have Chilean friends",
                     "F. Similarity between Chileans and [PER/HAI/VEN]",
                     "G. Loose of identity because of immigrants ",
                     "H. Immigrant keeping their customs",
                     "I. Adoption of Chilean customs",
                     "J. Unemployment increases")
#set Column names of the matrix
colnames(cor_3) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)","(H)","(I)","(J)")
#Plot the matrix using corrplot
corrplot::corrplot(cor_3,
  method = "color",
  addCoef.col = "#000390",
  type = "upper",
  tl.col = "black",
  col=colorRampPalette(c("white","#0068DC"))(12),
  bg = "white",
  na.label = "-",
  title = "\n Wave 3")

# Wave 4_______________________________________________________________________
mat_4 <- 
df_study_long_t5_comunas %>%
  filter(ola==4) %>% 
  select(in_ansied,in_simpat,in_valfam, in_valami,in_amigcl, # conviviality
         in_simili,in_amsimb,in_acpier, in_acadop, # identity
         in_amreal # threat
         ) %>% 
  psych::mixedCor() 


cor_4 <- as.matrix(mat_4$rho)
diag(cor_4) = NA #set diagonal values to NA
# Set Row names of the matrix
rownames(cor_4) <- c("A. Interaction anxiety with [PER/HAI/VEN]",
                     "B. Sympathy for [PER/HAI/VEN] living in Chile",
                     "C. Family value of immigrant friends [PER/HAI/VEN]",
                     "D. Friends value of immigrant friends [PER/HAI/VEN]",
                     "E. Immigrants [PER/HAI/VEN] have Chilean friends",
                     "F. Similarity between Chileans and [PER/HAI/VEN]",
                     "G. Loose of identity because of immigrants ",
                     "H. Immigrant keeping their customs",
                     "I. Adoption of Chilean customs",
                     "J. Unemployment increases")
#set Column names of the matrix
colnames(cor_4) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)","(H)","(I)","(J)")
#Plot the matrix using corrplot
corrplot::corrplot(cor_4,
  method = "color",
  addCoef.col = "#000390",
  type = "upper",
  tl.col = "black",
  col=colorRampPalette(c("white","#0068DC"))(12),
  bg = "white",
  na.label = "-",
  title = "\n Wave 4")


# Wave 5_______________________________________________________________________
mat_5 <- 
df_study_long_t5_comunas %>%
  filter(ola==5) %>% 
  select(in_ansied,in_simpat,in_valfam, in_valami,in_amigcl, # conviviality
         in_simili,in_amsimb,in_acpier, in_acadop, # identity
         in_amreal # threat
         ) %>% 
  psych::mixedCor() 

cor_5 <- as.matrix(mat_5$rho)
diag(cor_5) = NA #set diagonal values to NA
# Set Row names of the matrix
rownames(cor_5) <- c("A. Interaction anxiety with [PER/HAI/VEN]",
                     "B. Sympathy for [PER/HAI/VEN] living in Chile",
                     "C. Family value of immigrant friends [PER/HAI/VEN]",
                     "D. Friends value of immigrant friends [PER/HAI/VEN]",
                     "E. Immigrants [PER/HAI/VEN] have Chilean friends",
                     "F. Similarity between Chileans and [PER/HAI/VEN]",
                     "G. Loose of identity because of immigrants ",
                     "H. Immigrant keeping their customs",
                     "I. Adoption of Chilean customs",
                     "J. Unemployment increases")
#set Column names of the matrix
colnames(cor_5) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)","(H)","(I)","(J)")
#Plot the matrix using corrplot
corrplot::corrplot(cor_5,
  method = "color",
  addCoef.col = "#000390",
  type = "upper",
  tl.col = "black",
  col=colorRampPalette(c("white","#0068DC"))(12),
  bg = "white",
  na.label = "-",
  title = "\n Wave 5")
```

# Models

```{r, results='asis',fig.dim=c(10,6)}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               summarytools,
               lme4,
               texreg,
               sjPlot
               )
load(file = here::here("input/data-proc/df_study_t5_ind_comunas.RData"))

# generate analytical sample
df_study1 <- 
  df_study_long_t5_comunas %>%
  select(idencuesta,ola,comuna,cuestion_mig,
         in_ansied,in_simpat,in_valfam,in_valami,in_amigcl,
         in_simili,in_amsimb,in_acpier,in_acadop,
         conviviality, identity,
         in_amreal,educ,quintil1:edad,
         inm_prop_cas17_w,inm_prop_cas20_w,dif_inm) %>% 
  na.omit() %>% 
  mutate(
    # conviviality=(in_ansied+in_simpat+in_valfam+in_valami+in_amigcl)/5,
         # identity= (in_simili+in_amsimb+in_acpier+in_acadop)/4,
         ola_f = ola,
         ola=as.numeric(ola),
         -in_amreal
         )

# Hypothesis___________________________________________________________________
h1.cat <- "ola_f+educ+quintil1+ess+know_inm_t1t4+frien_inm_t1t4+pos_id+edad+inm_prop_cas20_w+dif_inm+nation_t1+cuestion_mig"
h1 <- "ola+educ+quintil1+ess+know_inm_t1t4+frien_inm_t1t4+pos_id+edad+inm_prop_cas20_w+dif_inm+nation_t1+cuestion_mig"
h2.educ <- "ola*educ+quintil1+ess+know_inm_t1t4+frien_inm_t1t4+pos_id+edad+inm_prop_cas20_w+dif_inm+nation_t1+cuestion_mig"
h2.incom <- "ola+educ+quintil1*ola+ess+know_inm_t1t4+frien_inm_t1t4+pos_id+edad+inm_prop_cas20_w+dif_inm+nation_t1+cuestion_mig"
h3 <- "ola*dif_inm+educ+quintil1+ess+know_inm_t1t4+frien_inm_t1t4+pos_id+edad+inm_prop_cas20_w+dif_inm+nation_t1+cuestion_mig"
h4.know <- "ola+dif_inm+educ+quintil1+ess+know_inm_t1t4*ola+frien_inm_t1t4+pos_id+edad+inm_prop_cas20_w+dif_inm+nation_t1+cuestion_mig"
h4.friend <- "ola+dif_inm+educ+quintil1+ess+know_inm_t1t4+frien_inm_t1t4*ola+pos_id+edad+inm_prop_cas20_w+dif_inm+nation_t1+cuestion_mig"

hipotesis <- c(h1.cat,h1,h2.educ,h2.incom,h3,h4.know,h4.friend)
# Set the independent variables (IVs)
ivs<- df_study1 %>% select(starts_with("in_"),"conviviality","identity") %>% names()

# Create the object for each model
models <- list()
for (i in ivs) {
models[[i]] <- paste0(i,"~",hipotesis,"+(1|idencuesta)+(1|comuna)")  
}

# Estimate the multilevel models
fits <- list()
for (i in ivs) {
  for (z in models[[i]][1:length(hipotesis)]) {
    fits[[z]] <- lme4::lmer(formula = z, data = df_study1)
  }
}
fit1 <- fits
# change model names within list
names(fit1) <- paste0(rep(ivs,each=length(hipotesis)),1:length(hipotesis))


# Tables_______________________________________________________________________
omit <- "(pos_id)|(edad)|(cuestion_mig)|(nation_t1)|(quintil1QNA)|(Intercept)"
reorderc <- c(1:4,19,5:18,20:31) # the depends on the number of coeficients (!)
# detail for subsections:
# https://stackoverflow.com/questions/69338331/r-markdown-create-section-headers-in-r-and-print-r-output-in-same-section

cat(paste0("\n## ","A. Anxiety","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_ansied", names(fit1))]],
        omit.coef = omit,reorder.coef = reorderc)

cat(paste0("\n## ","B. Simpathy ","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_simpat", names(fit1))]],
        omit.coef = omit,reorder.coef = reorderc)

cat(paste0("\n## ","C. Family value migrant friends","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_valfam", names(fit1))]],
        omit.coef = omit,reorder.coef = reorderc)

cat(paste0("\n## ","D. Friend value migrant friends","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_valami", names(fit1))]],
        omit.coef = omit,reorder.coef = reorderc)

cat(paste0("\n## ","E. Immigrants have Chilean friends","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_amigcl", names(fit1))]],
        omit.coef = omit,reorder.coef = reorderc)

cat(paste0("\n## ","Conviviality (average)","\n"))

knitreg(l = fit1[names(fit1)[grepl("conviviality", names(fit1),"\n")]],
        omit.coef = omit,reorder.coef = reorderc)

plot_model(model = fit1$conviviality3,
           type = "int")

plot_model(model = fit1$conviviality6,
           type = "int")

plot_model(model = fit1$conviviality7,
           type = "int")

#______________________________________________________________________________


cat(paste0("\n## ","F. Similarity","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_simili", names(fit1))]],
        omit.coef = omit,reorder.coef = reorderc)

cat(paste0("\n## ","G. Loose identity","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_amsimb", names(fit1))]],
        omit.coef = omit,reorder.coef = reorderc)

cat(paste0("\n## ","H. Immigrants keep customs","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_acpier", names(fit1))]],
        omit.coef = omit,reorder.coef = reorderc)

cat(paste0("\n## ","I. Adopt chilean customs","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_acadop", names(fit1))]],
        omit.coef = omit,reorder.coef = reorderc)

cat(paste0("\n## ","Identity (average)","\n"))

knitreg(l = fit1[names(fit1)[grepl("identity", names(fit1),"\n")]],
        omit.coef = omit,reorder.coef = reorderc)

#______________________________________________________________________________

cat(paste0("\n## ","J. Unemployment increases (Threat)","\n"))

knitreg(l = fit1[names(fit1)[grepl("in_amreal", names(fit1),"\n")]],
        omit.coef = omit,reorder.coef = reorderc) 

plot_model(model = fit1$in_amreal3,
           type = "int") 

plot_model(model = fit1$in_amreal5,
           type = "int")

plot_model(model = fit1$in_amreal6,
           type = "int")
```
